<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>[Android开发]使用Matrix进行坐标变换 | 海海杂说</title><link rel=icon type=image/x-icon href=/favicon/favicon-32x32.png><meta name=copyright content="© Copyright 2025. All rights reserved."><meta name=keywords content="android,matrix"><meta name=description content="在Android使用Matrix来转换坐标"><meta name=robots content="index,follow"><link rel=stylesheet href=/css/main.min.4161a2f58aba7f239c5d630a2193e893e99cc5b13376e084e11ee73ea9599550.css integrity="sha256-QWGi9Yq6fyOcXWMKIZPok+mcxbEzduCE4R7nPqlZlVA=" crossorigin=anonymous><link rel=stylesheet href=/css/github-markdown.min.ee481479a5f04c7d701db0c6200f10242416b3f4d2a3c073fdc6a09e145dccb8.css integrity="sha256-7kgUeaXwTH1wHbDGIA8QJCQWs/TSo8Bz/cagnhRdzLg=" crossorigin=anonymous><link rel=stylesheet href=/css/iconfont.min.daa5136180ec22c6e9c0b91c926f85d1272434432a6bbd6cb3a571743fdfeb08.css integrity="sha256-2qUTYYDsIsbpwLkckm+F0SckNEMqa71ss6VxdD/f6wg=" crossorigin=anonymous><link rel=stylesheet href=/css/media.min.6d93cf55b3f365f2dd3f8f9f6c60742648bc4d87b03c5c0e947d9950844bf62a.css integrity="sha256-bZPPVbPzZfLdP4+fbGB0Jki8TYewPFwOlH2ZUIRL9io=" crossorigin=anonymous><script src=/js/dayjs.min.js></script><script src=/js/relativeTime.js></script><script src=/js/zh-cn.js></script><script src=/js/main.f131ccf6104a927521a409081c405198f6e1a22c1adeff2e4f0c4e55ad2e2f65.js integrity="sha256-8THM9hBKknUhpAkIHEBRmPbhoiwa3v8uTwxOVa0uL2U=" crossorigin=anonymous></script><meta name=file content="posts/0008 Android Matrix/index.md"><meta name=color-scheme content="light"></head><body><header><div class=site-header><a href=https://www.lsz.sc.cn/ class=site-title><img src=/favicon/logo.png class=site-title-logo>
<span class=site-title-text>海海杂说</span></a><div></div><div class=site-menus><nav><ul><li><a href=/><i class="iconfont icon-home"></i>
首页</a></li><li><a aria-current=true class=ancestor href=/posts/><i class="iconfont icon-medium"></i>
博客</a></li><li><a href=/products/><i class="iconfont icon-chanpin"></i>
产品</a></li><li><a href=/moments/><i class="iconfont icon-shejiaotubiao-02"></i>
动态</a></li><li><a href=/about/><i class="iconfont icon-guanyuwomen"></i>
关于</a></li></ul></nav></div></div></header><main><div class=details><div class=details-title>[Android开发]使用Matrix进行坐标变换</div><hr class=divider><div class=created>发表于：2025-10-16 21:34:10</div><div class="content markdown-body"><p>在前面的文章(<a href=https://www.lsz.sc.cn/posts/android-camerax/ title target=_blank>https://www.lsz.sc.cn/posts/android-camerax/</a>)中，我们是在视频信息的上面又放置了一层，用来绘制目标框，主要用来框出视频中人脸所在的位置。但在前面，我们只是简单的画了一个框，实际的应用要复杂一些。</p><p>在实际中，我们在进行目标检测的时候，传入的图片是摄像头原始的图片大小，所以目标检测方法得到的也是基于原始图片的人脸框的位置，我们如果根据原始图片中人脸的位置来绘制目标框，则肯定会是一个错误的位置。</p><p>基于上面的信息，我们知道，人脸框位置错误的原因是为在实际原始的图片大小于屏幕上显示的图片大小不一致，导致位置错误，那我们有两钟方式来解决这个问题。</p><h1 id=一直接在图片上画框>一、直接在图片上画框</h1><p>这是最直接的方式。在前面，我们通过<code>ImageAnalysis</code>来检测人脸的位置，我们同样可以对原始的检测图片进行处理，在图片上添加人脸框以及相关的<code>label</code>信息，再将画了框的图片输出到屏幕上，由系统底层完成图片的缩放。</p><p>因为框已经画在原始图片上了，系统在缩放显示的时候，框的位置也跟着变化。</p><h1 id=二坐标变换>二、坐标变换</h1><p>基于坐标变换的话，我们就还是使用原来的方案，在视频上覆盖一个画布，用于实时绘制人脸框。只是在绘制的时候，需要将坐标变换为画布的坐标。</p><p>变换的算法可以我们自己去实现，但没必要，这里就使用我们上面说到的<code>Matrix</code>类来实现。</p><p>我们使用的是Android图形库中的<code>android.graphics.Matrix</code>，其主要作用就是用来实现坐标变换。</p><p>大概是下面的样子：</p><p><img src=/posts/android-matrix/image.png alt="alt text"></p><p>其中每个字段的含义如下：</p><ul><li>MSCALE_X、MSCALE_Y：控制缩放</li><li>MTRANS_X、MTRANS_Y：控制平移</li><li>MSKEW_X、MSKEW_X：控制错切</li><li>MSCALE_X、MSCALE_Y、MSKEW_X、MSKEW_X：控制旋转</li><li>MPERSP_0、MPERSP_1、MPERSP_2：控制透视</li></ul><p>如下图的结构：</p><p><img src=/posts/android-matrix/image-1.png alt="alt text"></p><p>当然，我们不会在这里做深入的介绍，只仅仅需要完成我们的目标，将图片上人脸框的坐标变换为适合屏幕上显示的信息的坐标信息。</p><p>在<code>Matrix</code>类中，提供了实例方法<code>public boolean mapRect(RectF dst,RectF src)</code>和<code>public boolean mapRect(RectF rect)</code>，都是用于坐标变换，区别仅仅是坐标源坐标的输入位置不同。</p><p>我们的完整变换函数入下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> RectF <span style=color:#a6e22e>Transform</span>(RectF box) {
</span></span><span style=display:flex><span>    RectF onScreenRect <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> RectF(box);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>assert</span> matrix <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>    matrix.<span style=color:#a6e22e>mapRect</span>(onScreenRect);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> onScreenRect;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>我们这里的<code>matrix</code>是通过前面文章中的<code>previewView.getSensorToViewTransform()</code>获得的。</p><p>到这里，我们就可以使用新的坐标来绘制人脸框。</p><p>如果你想要了解为什么可以使用<code>mapRect</code>来变换坐标，你需要去了解<code>Matrix</code>的变换原理。</p></div></div></main><footer><p>© Copyright 2025. All rights reserved.</p><p><a href=https://beian.miit.gov.cn/#/Integrated/index target=_blank>蜀ICP备2023031169号-1</a></p></footer></body></html>