<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>你以为你请求的就是你想请求的吗？ | 海海杂说</title><link rel=icon type=image/x-icon href=/favicon/favicon-32x32.png><meta name=copyright content="© Copyright 2025. All rights reserved."><meta name=robots content="index,follow"><link rel=stylesheet href=/css/main.min.cdf1df9f75a8c5bad628dcafe44fb0ec69ac8dbf5b0ff081ad5e6635b4eff990.css integrity="sha256-zfHfn3WoxbrWKNyv5E+w7Gmsjb9bD/CBrV5mNbTv+ZA=" crossorigin=anonymous><link rel=stylesheet href=/css/github-markdown.min.ee481479a5f04c7d701db0c6200f10242416b3f4d2a3c073fdc6a09e145dccb8.css integrity="sha256-7kgUeaXwTH1wHbDGIA8QJCQWs/TSo8Bz/cagnhRdzLg=" crossorigin=anonymous><link rel=stylesheet href=/css/iconfont.min.daa5136180ec22c6e9c0b91c926f85d1272434432a6bbd6cb3a571743fdfeb08.css integrity="sha256-2qUTYYDsIsbpwLkckm+F0SckNEMqa71ss6VxdD/f6wg=" crossorigin=anonymous><link rel=stylesheet href=/css/media.min.e90b6071ab53a9c302681b20f033844f4b7ff488d2a6225ea25533b9868f6244.css integrity="sha256-6QtgcatTqcMCaBsg8DOET0t/9IjSpiJeolUzuYaPYkQ=" crossorigin=anonymous><script src=/js/dayjs.min.js></script><script src=/js/relativeTime.js></script><script src=/js/zh-cn.js></script><script src=/js/main.f131ccf6104a927521a409081c405198f6e1a22c1adeff2e4f0c4e55ad2e2f65.js integrity="sha256-8THM9hBKknUhpAkIHEBRmPbhoiwa3v8uTwxOVa0uL2U=" crossorigin=anonymous></script><meta name=file content="posts/0001 你以为你请求的就是你想请求的吗？/index.md"></head><body><header><div class=site-header><a href=https://www.lsz.sc.cn/ class=site-title><img src=/favicon/logo.png class=site-title-logo>
<span class=site-title-text>海海杂说</span></a><div></div><div class=site-menus><nav><ul><li><a href=/><i class="iconfont icon-home"></i>
首页</a></li><li><a aria-current=true class=ancestor href=/posts/><i class="iconfont icon-medium"></i>
博客</a></li><li><a href=/products/><i class="iconfont icon-chanpin"></i>
产品</a></li><li><a href=/moments/><i class="iconfont icon-shejiaotubiao-02"></i>
动态</a></li><li><a href=/about/><i class="iconfont icon-guanyuwomen"></i>
关于</a></li></ul></nav></div></div></header><main><div class=details><div class=details-title>你以为你请求的就是你想请求的吗？</div><hr class=divider><div class=created>发表于：2021-11-04 00:00:00</div><div class="content markdown-body"><p>在如今SPA应用流行的情况下，页面上的所有东西都是通过javascript进行加载，本文将带你一步一步截获用户请求，并修改请求地址。</p><p>我们主要使用的方法为Hook原生接口进行接口调用拦截；在拦截前，先定义一个URL修改的函数，统一将URL请求中的before修改为after，你在你的实际处理中可能会更加复杂。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>srcHook</span>(<span style=color:#a6e22e>url</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>nUrl</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>url</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#34;hook-before&#34;</span>, <span style=color:#e6db74>&#34;hook-after&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>nUrl</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h1 id=ajax请求>Ajax请求</h1><p>在前端中，一般是通过Ajax向后台请求数据，所以首要需要拦截的就是Ajax的请求。</p><p>先来看一下如何发出一个Ajax请求：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>xhr</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>XMLHttpRequest</span>();
</span></span><span style=display:flex><span><span style=color:#a6e22e>xhr</span>.<span style=color:#a6e22e>timeout</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>3000</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>xhr</span>.<span style=color:#a6e22e>ontimeout</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>event</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>alert</span>(<span style=color:#e6db74>&#34;请求超时！&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>xhr</span>.<span style=color:#a6e22e>open</span>(<span style=color:#e6db74>&#39;GET&#39;</span>, <span style=color:#e6db74>&#39;/data/hook-before.txt&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>xhr</span>.<span style=color:#a6e22e>send</span>();
</span></span><span style=display:flex><span><span style=color:#a6e22e>xhr</span>.<span style=color:#a6e22e>onreadystatechange</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span> () {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>xhr</span>.<span style=color:#a6e22e>readyState</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>xhr</span>.<span style=color:#a6e22e>status</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>200</span>) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>         <span style=color:#a6e22e>resolve</span>(<span style=color:#a6e22e>xhr</span>.<span style=color:#a6e22e>responseText</span>);
</span></span><span style=display:flex><span>         <span style=color:#a6e22e>WriteLogs</span>(<span style=color:#e6db74>&#34;====响应 &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>xhr</span>.<span style=color:#a6e22e>responseText</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>可以看到，传入URL参数的方法是<code>xhr.open</code>，所以我们重写<code>XMLHttpRequest</code>的<code>open</code>方法进行拦截。<strong>重写前，需要先保存一下原生方法。</strong></p><p>好了，现在开始正式Hook了：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>$open</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>XMLHttpRequest</span>.<span style=color:#a6e22e>prototype</span>.<span style=color:#a6e22e>open</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>XMLHttpRequest</span>.<span style=color:#a6e22e>prototype</span>.<span style=color:#a6e22e>open</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span> () {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>srcHook</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>src</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>srcHook</span>(<span style=color:#a6e22e>arguments</span>[<span style=color:#ae81ff>1</span>]);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>src</span> <span style=color:#f92672>===</span> <span style=color:#66d9ef>false</span>) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>src</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>arguments</span>[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>src</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>$open</span>.<span style=color:#a6e22e>apply</span>(<span style=color:#66d9ef>this</span>, <span style=color:#a6e22e>arguments</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>是的，就是这么简单，在重写的<code>open</code>方法中，对URL参数进行修改，然后调用原生方法。</p><p>通过我们的日志信息，可以看到，访问修改已经成功：</p><p><img src=/posts/0001/1.webp alt=1></p><p>没问题，Hook成功。但是，你看下面，还有一个<code>fetch</code>类型的请求没有Hook到，别着急，马上处理它。</p><p>仍然首先来看一下<code>fetch</code>的调用方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#a6e22e>fetch</span>(<span style=color:#e6db74>&#34;/data/hook-before.txt&#34;</span>)
</span></span><span style=display:flex><span>.<span style=color:#a6e22e>then</span>(<span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>response</span>){
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>text</span>();
</span></span><span style=display:flex><span>}).<span style=color:#a6e22e>then</span>(<span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>text</span>){
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>alert</span>(<span style=color:#a6e22e>text</span>);
</span></span><span style=display:flex><span>})
</span></span></code></pre></div><p><code>fetch</code>是一个全局函数，第一个参数为需要请求的网址。我们只需要重写<code>window</code>对象上的<code>fetch</code>函数即可。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>$fetch</span> <span style=color:#f92672>=</span> window.<span style=color:#a6e22e>fetch</span>;
</span></span><span style=display:flex><span>window.<span style=color:#a6e22e>fetch</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span> () {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>srcHook</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>src</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>srcHook</span>(<span style=color:#a6e22e>arguments</span>[<span style=color:#ae81ff>0</span>]);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>src</span> <span style=color:#f92672>===</span> <span style=color:#66d9ef>false</span>) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>src</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>arguments</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>src</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>$fetch</span>.<span style=color:#a6e22e>apply</span>(window, <span style=color:#a6e22e>arguments</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这下没问题了，两种请求方式都拦截了。</p><h1 id=dom请求>DOM请求</h1><p>对于正常的Ajax请求，我们已经进行了处理，但在有些情况下，会在页面中使用<code>JSONP</code>来进行跨域请求。</p><p>我们仍然是先来看一下<code>JSONP</code>的实现：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>url</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/data/hook-before.js&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>script</span> <span style=color:#f92672>=</span> document.<span style=color:#a6e22e>createElement</span>(<span style=color:#e6db74>&#39;script&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>script</span>.<span style=color:#a6e22e>setAttribute</span>(<span style=color:#e6db74>&#39;src&#39;</span>, <span style=color:#a6e22e>url</span>);
</span></span><span style=display:flex><span>document.<span style=color:#a6e22e>getElementsByTagName</span>(<span style=color:#e6db74>&#39;head&#39;</span>)[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>appendChild</span>(<span style=color:#a6e22e>script</span>);
</span></span></code></pre></div><p>可以看出，JSONP的本质是向DOM中插入一个SCRIPT的Element。从代码中，我轻松的找到的Hook点，Element实例的<code>setAttribute</code>方法。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>$setAttribute</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Element</span>.<span style=color:#a6e22e>prototype</span>.<span style=color:#a6e22e>setAttribute</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>Element</span>.<span style=color:#a6e22e>prototype</span>.<span style=color:#a6e22e>setAttribute</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span> () {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>tagName</span><span style=color:#f92672>==</span><span style=color:#e6db74>&#34;SCRIPT&#34;</span><span style=color:#f92672>&amp;&amp;</span><span style=color:#a6e22e>arguments</span>[<span style=color:#ae81ff>0</span>]<span style=color:#f92672>==</span><span style=color:#e6db74>&#34;src&#34;</span><span style=color:#f92672>&amp;&amp;</span><span style=color:#a6e22e>srcHook</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>src</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>srcHook</span>(<span style=color:#a6e22e>arguments</span>[<span style=color:#ae81ff>1</span>]);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>src</span> <span style=color:#f92672>===</span> <span style=color:#66d9ef>false</span>) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>src</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>arguments</span>[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>src</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>$setAttribute</span>.<span style=color:#a6e22e>apply</span>(<span style=color:#66d9ef>this</span>, <span style=color:#a6e22e>arguments</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>和xhr的hook完全一样。</p><blockquote><p>通过同样的方法，也可以把<code>img</code>、<code>link</code>、<code>iframe</code>、<code>a</code>给hook掉。</p></blockquote><p>然而，上面的hook好像也差了点啥。请看下面的代码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>url</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/data/hook-before.js&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>script</span> <span style=color:#f92672>=</span> document.<span style=color:#a6e22e>createElement</span>(<span style=color:#e6db74>&#39;script&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>script</span>.<span style=color:#a6e22e>src</span><span style=color:#f92672>=</span><span style=color:#a6e22e>url</span>;
</span></span><span style=display:flex><span>document.<span style=color:#a6e22e>getElementsByTagName</span>(<span style=color:#e6db74>&#39;head&#39;</span>)[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>appendChild</span>(<span style=color:#a6e22e>script</span>);
</span></span></code></pre></div><p>没错，不调用<code>setAttribute</code>方法一样可以设置<code>src</code>。</p><p>先看一看<code>src</code>在原型链上的定义：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>{<span style=color:#a6e22e>get</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>ƒ</span>, <span style=color:#a6e22e>set</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>ƒ</span>, <span style=color:#a6e22e>enumerable</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>configurable</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>}
</span></span></code></pre></div><p>通过定义可以知道<code>src</code>的属性描述符(property descriptor)就可以重写的，这下好办了，我们重写一下<code>src</code>的<code>setter</code>。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>descriptor</span><span style=color:#f92672>=</span>Object.<span style=color:#a6e22e>getOwnPropertyDescriptor</span>(<span style=color:#a6e22e>HTMLScriptElement</span>.<span style=color:#a6e22e>prototype</span>, <span style=color:#e6db74>&#34;src&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>setter</span><span style=color:#f92672>=</span><span style=color:#a6e22e>descriptor</span>[<span style=color:#e6db74>&#34;set&#34;</span>];
</span></span><span style=display:flex><span><span style=color:#a6e22e>descriptor</span>[<span style=color:#e6db74>&#34;set&#34;</span>]<span style=color:#f92672>=</span><span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>value</span>){
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>srcHook</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>src</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>srcHook</span>(<span style=color:#a6e22e>arguments</span>[<span style=color:#ae81ff>0</span>]);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>src</span> <span style=color:#f92672>===</span> <span style=color:#66d9ef>false</span>) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>src</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>arguments</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>src</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>setter</span>.<span style=color:#a6e22e>apply</span>(<span style=color:#66d9ef>this</span>, <span style=color:#a6e22e>arguments</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>descriptor</span>[<span style=color:#e6db74>&#34;configurable&#34;</span>]<span style=color:#f92672>=</span><span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span><span style=color:#75715e>//由于src的set有可能会被其它脚本修改回去，此处通过设置configurable=false来强行禁止修改
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>Object.<span style=color:#a6e22e>defineProperty</span>(<span style=color:#a6e22e>HTMLScriptElement</span>.<span style=color:#a6e22e>prototype</span>, <span style=color:#e6db74>&#34;src&#34;</span>, <span style=color:#a6e22e>descriptor</span>);
</span></span></code></pre></div><blockquote><p>通过同样的方法，也可以把<code>img</code>、<code>link</code>、<code>iframe</code>、<code>a</code>，<code>style</code>中和URL相关的属性处理掉。</p></blockquote><p><strong>提示：</strong><code>innerHTML</code>也是通过这种方法进行处理。</p><h1 id=css中的请求>CSS中的请求</h1><p>要发起一个请求，除了上面描述的方法外，也可以通过css中的<code>background-image</code>属性发起。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>document.<span style=color:#a6e22e>getElementById</span>(<span style=color:#e6db74>&#34;#id&#34;</span>).<span style=color:#a6e22e>style</span>.<span style=color:#a6e22e>background</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;url(/data/hook-before.jpg)&#34;</span>;
</span></span></code></pre></div><p>CSS属性属于<code>CSSStyleDeclaration</code>对象，该对象的原型上有以下属性可以发起请求：</p><ul><li>cssText</li><li>background-image</li><li>background</li><li>border-image</li><li>borderImage</li><li>border-image-source</li><li>borderImageSource</li></ul><p>使用代码示例中的方法设置CSS属性，会直接发起请求，我们无法拦截。但是，我们可以通过调用<code>CSSStyleDeclaration</code>的<code>setProperty</code>方法进行属性设置，所以我们需要在<code>CSSStyleDeclaration</code>的原型链上定义上面的属性，通过设置<code>setter</code>和<code>getter</code>，然后调用<code>setProperty</code>方法进行实际设置。代码示例如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>    Object.<span style=color:#a6e22e>defineProperty</span>(<span style=color:#a6e22e>CSSStyleDeclaration</span>.<span style=color:#a6e22e>prototype</span>, <span style=color:#e6db74>&#34;background&#34;</span>,
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>get</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>function</span> () {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getPropertyValue</span>(<span style=color:#e6db74>&#34;background&#34;</span>);
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>set</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>v</span>) {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>v</span><span style=color:#f92672>=</span><span style=color:#a6e22e>srcHook</span>(<span style=color:#a6e22e>v</span>);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>setProperty</span>(<span style=color:#e6db74>&#34;background&#34;</span>, <span style=color:#a6e22e>v</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>    Object.<span style=color:#a6e22e>defineProperty</span>(<span style=color:#a6e22e>CSSStyleDeclaration</span>.<span style=color:#a6e22e>prototype</span>, <span style=color:#e6db74>&#34;background-image&#34;</span>,
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>get</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>function</span> () {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getPropertyValue</span>(<span style=color:#e6db74>&#34;background-image&#34;</span>);
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>set</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>v</span>) {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>v</span><span style=color:#f92672>=</span><span style=color:#a6e22e>srcHook</span>(<span style=color:#a6e22e>v</span>);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>setProperty</span>(<span style=color:#e6db74>&#34;background-image&#34;</span>, <span style=color:#a6e22e>v</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>descriptor</span> <span style=color:#f92672>=</span> Object.<span style=color:#a6e22e>getOwnPropertyDescriptor</span>(<span style=color:#a6e22e>CSSStyleDeclaration</span>.<span style=color:#a6e22e>prototype</span>, <span style=color:#e6db74>&#34;setProperty&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>valuer</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>descriptor</span>[<span style=color:#e6db74>&#34;value&#34;</span>];
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>descriptor</span>[<span style=color:#e6db74>&#34;value&#34;</span>] <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span> () {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>srcHook</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>src</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>srcHook</span>(<span style=color:#a6e22e>arguments</span>[<span style=color:#ae81ff>1</span>]);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>src</span> <span style=color:#f92672>===</span> <span style=color:#66d9ef>false</span>) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>src</span>) {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>arguments</span>[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>src</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>valuer</span>.<span style=color:#a6e22e>apply</span>(<span style=color:#66d9ef>this</span>, <span style=color:#a6e22e>arguments</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>descriptor</span>[<span style=color:#e6db74>&#34;configurable&#34;</span>] <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>    <span style=color:#75715e>//由于src的set有可能会被其它脚本修改回去，此处通过设置configurable=false来强行禁止修改
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Object.<span style=color:#a6e22e>defineProperty</span>(<span style=color:#a6e22e>CSSStyleDeclaration</span>.<span style=color:#a6e22e>prototype</span>, <span style=color:#e6db74>&#34;setProperty&#34;</span>, <span style=color:#a6e22e>descriptor</span>);
</span></span></code></pre></div><blockquote><p>由于在对<code>background-image</code>，<code>background</code>等属性进行hook时，调用了<code>setProperty</code>方法进行设置，若原代码中直接就调用的<code>setProperty</code>方法进行设置，则需要对<code>setProperty</code>的属性描述符(property descriptor)进行重写。</p></blockquote><h1 id=html中的请求>HTML中的请求</h1><p>HTML中的请求，我们无法进行拦截，但可以使用<code>MutationObserver</code>监听<code>DOM</code>对象的创建，对于其中的<code>a</code>标签，可以修改<code>href</code>属性。对于<code>img</code>的<code>src</code>属性也可以修改，但无法阻止请求的发出，修改后的请求也会正常发出。</p><p>我们先在HTML中添加一个图片显示的DOM</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#f92672>img</span> <span style=color:#a6e22e>src</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/data/hook-before.jpg&#34;</span> /&gt;
</span></span></code></pre></div><p>在没有监听和修改前，页面显示的是HOOK前的图片，如下：</p><p><img src=/posts/0001/2.webp alt=2></p><p>然后，我们在JS中添加监听和修改的代码，我们仅用IMG进行测试：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>DomWatch</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// part 1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>observer</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>MutationObserver</span>(<span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>mutationsList</span>, <span style=color:#a6e22e>mutationObserver</span>){
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>mutationsList</span>.<span style=color:#a6e22e>forEach</span>(<span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>mutation</span>){
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span>(<span style=color:#f92672>!</span><span style=color:#a6e22e>mutation</span>.<span style=color:#a6e22e>addedNodes</span>) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>mutation</span>.<span style=color:#a6e22e>addedNodes</span>.<span style=color:#a6e22e>forEach</span>(<span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>node</span>){
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>tagName</span><span style=color:#f92672>!==</span><span style=color:#e6db74>&#34;IMG&#34;</span>) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>src</span><span style=color:#f92672>=</span><span style=color:#a6e22e>srcHook</span>(<span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>src</span>);
</span></span><span style=display:flex><span>            })
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    <span style=color:#75715e>// part 2
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>observer</span>.<span style=color:#a6e22e>observe</span>(document, {<span style=color:#a6e22e>childList</span><span style=color:#f92672>:</span><span style=color:#66d9ef>true</span>,<span style=color:#a6e22e>attributes</span><span style=color:#f92672>:</span><span style=color:#66d9ef>true</span>,<span style=color:#a6e22e>subtree</span><span style=color:#f92672>:</span><span style=color:#66d9ef>true</span>});
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>DomWatch</span>();
</span></span></code></pre></div><p>保存，然后刷新一下页面，可以发现显示的图片已经发生了改变。</p><p><img src=/posts/0001/3.webp alt=3></p><p>在这里，虽然我们看到的图片已经发生了变化，但实际是在HTML中指定的图片依然会发出请求。</p><p><img src=/posts/0001/4.webp alt=4></p><p>在Developer Tools的网络标签中，可以看到，发出了两次图片请求。</p><p>关于<code>MutationObserver</code>的具体用法，请可以参考</p><ul><li><a href=https://developer.mozilla.org/zh-CN/docs/Web/API/MutationObserver title target=_blank>https://developer.mozilla.org/zh-CN/docs/Web/API/MutationObserver</a></li><li><a href=https://www.zhangxinxu.com/wordpress/2019/08/js-dom-mutation-observer/ title target=_blank>https://www.zhangxinxu.com/wordpress/2019/08/js-dom-mutation-observer/</a></li></ul><blockquote><p>在HTML中的DOM，也可以通过遍历的方式进行修改，但是如果用<code>innerHTML</code>创建的DOM，处理上就会比较麻烦。</p></blockquote><h1 id=websocket中的请求>WebSocket中的请求</h1><p>WebSocket中的请求是在<code>new</code>的时候指定的，如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>new</span> <span style=color:#a6e22e>WebSocket</span>(<span style=color:#e6db74>&#34;ws://121.40.165.18:8800&#34;</span>)
</span></span></code></pre></div><p>我们需要拦截WebSocket的<code>new</code>操作，并将连接地址修改为我们需要的地址，对于<code>new</code>的拦截，这里使用ES6的<code>Proxy</code>进行处理。在这里，我们统一将地址修改为<code>ws://119.29.3.36:6700/</code>。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>__WebSocket</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Proxy(window.<span style=color:#a6e22e>WebSocket</span>, {
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>construct</span>(<span style=color:#a6e22e>target</span>, <span style=color:#a6e22e>args</span>) {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>args</span>[<span style=color:#ae81ff>0</span>]<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;ws://119.29.3.36:6700/&#34;</span>;
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>target</span>(...<span style=color:#a6e22e>args</span>);
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>window.<span style=color:#a6e22e>WebSocket</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>__WebSocket</span>;
</span></span></code></pre></div><p><img src=/posts/0001/5.webp alt=5></p><h1 id=未解决的问题>未解决的问题</h1><p>如果在网页的脚本中，有通过<code>location</code>或<code>location.href</code>来重定向页面地址，则无法对这个动作进行拦截，<code>location</code>对象已经被浏览器定义为了不可伪造，目前没有找到好的办法，只能通过服务端代理，将调用该属性的js代码进行替换。</p><p>通过属性描述可以看到，<code>window</code>上的<code>location</code>和<code>location.href</code>均设置了不可修改。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>{<span style=color:#a6e22e>enumerable</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>configurable</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span>, <span style=color:#a6e22e>get</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>ƒ</span>, <span style=color:#a6e22e>set</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>ƒ</span>}
</span></span></code></pre></div><h1 id=写在最后>写在最后</h1><p>本文是以前在将淘宝手机页面搬进微信里显示的时候的研究结果，但后来这个也没有用起来，现在基于互联互通的政策要求，也就更没有使用场景了。</p><p>虽说如今的跨域策略基本能够保证被截获的请求也不能够进行跨域请求，但是也不能保证你随便安装的浏览器扩展不会拦截修改你的请求，所以在给浏览器扩展授权的时候，还需要擦亮眼睛。</p><p>本文的相关代码已上传：</p><ul><li><p><a href=https://gitee.com/zsea/jshook title target=_blank>https://gitee.com/zsea/jshook</a></p></li><li><p><a href=https://github.com/zsea/jshook title target=_blank>https://github.com/zsea/jshook</a></p></li></ul></div></div></main><footer><p>© Copyright 2025. All rights reserved.</p><p><a href=https://beian.miit.gov.cn/#/Integrated/index target=_blank>蜀ICP备2023031169号-1</a></p></footer></body></html>