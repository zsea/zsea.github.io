<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width"><title>Iptables学习笔记 | 海海杂说</title><link rel=icon type=image/x-icon href=/favicon/favicon-32x32.png><meta name=copyright content="© Copyright 2025. All rights reserved."><meta name=keywords content="iptables,netfilter,snat,dnat"><meta name=description content="这是一篇iptables的学习笔记，是个人的理解。"><meta name=robots content="index,follow"><link rel=stylesheet href=/css/main.min.ded89dd886a36b12c82783a3397d0c85754be45d90ed2320b32fe86bfec89578.css integrity="sha256-3tid2IajaxLIJ4OjOX0MhXVL5F2Q7SMgsy/oa/7IlXg=" crossorigin=anonymous><link rel=stylesheet href=/css/github-markdown.min.ee481479a5f04c7d701db0c6200f10242416b3f4d2a3c073fdc6a09e145dccb8.css integrity="sha256-7kgUeaXwTH1wHbDGIA8QJCQWs/TSo8Bz/cagnhRdzLg=" crossorigin=anonymous><link rel=stylesheet href=/css/iconfont.min.daa5136180ec22c6e9c0b91c926f85d1272434432a6bbd6cb3a571743fdfeb08.css integrity="sha256-2qUTYYDsIsbpwLkckm+F0SckNEMqa71ss6VxdD/f6wg=" crossorigin=anonymous><script src=/js/dayjs.min.js></script><script src=/js/relativeTime.js></script><script src=/js/zh-cn.js></script><script src=/js/main.f131ccf6104a927521a409081c405198f6e1a22c1adeff2e4f0c4e55ad2e2f65.js integrity="sha256-8THM9hBKknUhpAkIHEBRmPbhoiwa3v8uTwxOVa0uL2U=" crossorigin=anonymous></script><meta name=file content="posts/0002 iptables学习笔记/index.md"></head><body><header><div class=site-header><div class=site-title><img src=/favicon/logo.png class=site-title-logo>
<span class=site-title-text>海海杂说</span></div><div></div><div class=site-menus><nav><ul><li><a href=/><i class="iconfont icon-home"></i>
首页</a></li><li><a aria-current=true class=ancestor href=/posts/><i class="iconfont icon-medium"></i>
博客</a></li><li><a href=/products/><i class="iconfont icon-chanpin"></i>
产品</a></li><li><a href=/moments/><i class="iconfont icon-shejiaotubiao-02"></i>
动态</a></li><li><a href=/about/><i class="iconfont icon-guanyuwomen"></i>
关于</a></li></ul></nav></div></div></header><main><div class=details><div class=details-title>Iptables学习笔记</div><hr class=divider><div class=created>发表于：2025-06-07 23:57:27</div><div class="content markdown-body"><blockquote><p>这是一篇<code>iptables</code>的学习笔记，是个人的理解。
<code>iptables</code>对于我来说不常用到，所以每次用的时候都会再次学习，也没有深入的学习。学过的东西，久了不用，自然就忘了。所以在这里对个人的理解做一个笔记，方便下次用到的时候好看。</p></blockquote><h1 id=介绍>介绍</h1><p><code>iptables</code>是操作<code>netfilter</code>的工具，<code>netfilter</code>是Linux2.4.x之后新一代的Linux防火墙机制，是linux内核的一个子系统。<code>netfilter</code>采用模块化设计，具有良好的可扩充性。<code>iptables</code>从用户态连接到内核态的<code>netfilter</code>的架构中，<code>netfilter</code>与IP协议栈是无缝契合的，并允许使用者对数据报进行过滤、地址转换、处理等操作。</p><h1 id=原理理解>原理理解</h1><h2 id=5链4表>5链4表</h2><p>在<code>netfilter</code>中，有5链4表，数据包在<code>netfilter</code>中的流向如下图：
<img src=/posts/0002/1.png alt=链表图></p><p>5链是指：PREROUTING、INPUT、OUTPUT、FORWARD、POSTROUTING。
4表是指：raw&#187;&#187;mangle&#187;&#187;nat&#187;&#187;filter</p><p>数据包经过每一个链时，都会按照上面4张表的顺序查找表中的配置，根据配置来操作数据包。</p><blockquote><p>需要注意的是，不是每一个链都会包含4张表，根据链所处的位置和目的不同，包含的表也不同。可以理解为在不同的链中，能进行的操作是有限制的，比如<code>FORWARD</code>连，仅用于将数据包从一个接口转发到另一个接口，不需要进行地址转换操作，所以没有<code>nat</code>表。</p></blockquote><p>在这里，需要先了解清楚4表中每一个表记录的内容，才能更好的理解哪些链包含有哪些表：</p><ul><li><p>raw表
raw是1.2.9以后版本的新增的表，根据raw表的配置，可以决定数据包是否被状态跟踪机制处理。
数据包有4种跟踪连接状态：</p><ul><li>NEW - 该包想要开始一个连接（重新连接或将连接重定向）</li><li>RELATED - 该包是属于某个已经建立的连接所建立的新连接。例如：FTP的数据传输连接就是控制连接所 RELATED出来的连接。<code>--icmp-type 0</code> ( ping 应答) 就是<code>--icmp-type 8</code> (ping 请求)所RELATED出来的。</li><li>ESTABLISHED - 只要发送并接到应答，一个数据连接从NEW变为ESTABLISHED，而且该状态会继续匹配这个连接的后续数据包。<br>INVALID - 数据包不能被识别属于哪个连接或没有任何状态比如内存溢出，收到不知属于哪个连接的ICMP错误信息，一般应该DROP这个状态的任何数据。</li></ul></li><li><p>mangle表
主要用于修改数据包的TOS（Type Of Service，服务类型）、TTL（Time To Live，生存周期）以及为数据包设置Mark标记，以实现Qos(Quality Of Service，服务质量)调整以及策略路由等应用。<em>我们在这里不多介绍此表。</em></p></li><li><p>nat表
顾名思义，这个表主要用于网络地址转换，可用于修改数据包的IP地址、端口号等信息。</p></li><li><p>filter表
用于对数据包进行过滤，根据具体的规则决定是否放行该数据包（如DROP、ACCEPT、REJECT、LOG）。</p></li></ul><h2 id=数据包流向>数据包流向</h2><p>通过上图，我们可以直观的理解数据包在<code>netfilter</code>中的流向。</p><ol><li>数据包通过网卡进来后，首先到达的是<code>PREROUTING</code>链。</li><li>经过<code>PREROUTING</code>链处理后的数据，根据目的地址不同，会进入到不同的链。
若目的地址是本机的地址，则会交给<code>INPUT</code>链来处理，表示数据包将进入到本机系统进行处理。
若目的地址不在本机，则会对数据包进行转发，进入<code>FORWARD</code>链。</li><li>进入<code>INPUT</code>的数据，经过处理后会交给上层协议(应用)来处理。</li><li>上层应用发出的数据包，首先会经过<code>OUTPUT</code>处理后，再进行路由选择。</li><li>从<code>FORWARD</code>链或<code>OUTPUT</code>链出来的数据，经过路由选择后，交给<code>POSTROUTING</code>连处理，并最后通过网卡发送出去。</li></ol><blockquote><p>数据包在上面的任何一个链中，都可以被丢弃。</p></blockquote><h3 id=连接跟踪表>连接跟踪表</h3><p>连接跟踪表存储所有经过系统的网络连接状态信息。每个连接由​<strong>​五元组（源IP、目的IP、协议号、源端口、目的端口）​</strong>​唯一标识。例如：TCP连接 <code>10.1.1.2:55667 → 10.2.2.2:80</code> 会生成一条记录。每一条记录会记录连接的以下信息：</p><ul><li>协议类型 - TCP/UDP/ICMP等</li><li>五元组信息 - 源/目的IP、端口、协议号</li><li>连接状态 - 如<code>NEW</code>、<code>ESTABLISHED</code>、<code>RELATED</code></li><li>超时时间 - 空闲超时自动删除（如TCP默认30分钟）</li><li>流量统计 - 传输的数据包数量、字节数</li><li>反向五元组 - 记录响应方向的数据流信息</li></ul><h4 id=运作机制>运作机制</h4><ol><li>​<strong>​连接创建​</strong>​<ul><li>当新数据包到达时，内核提取其五元组，查询连接跟踪表。</li><li>若无匹配记录，则创建新表项，状态标记为<code>NEW</code> 。</li></ul></li><li>​<strong>​状态更新​</strong>​<ul><li>后续数据包命中表项后，更新连接状态（如TCP从<code>SYN_SENT</code>变为<code>ESTABLISHED</code>）。</li><li>同时刷新超时时间，避免过早回收。</li></ul></li><li>​<strong>​垃圾回收（GC）​</strong>​<ul><li>周期扫描表项，删除超时或无效（<code>INVALID</code>）记录。</li><li>标记为<code>ASSURED</code>的记录（双向通信确认）优先保留。</li></ul></li></ol><p>了解了<strong>连接跟踪表</strong>以后，就知道了如果在高并发状态下很容易造成连接跟踪表溢出，在这种场景下，可以通过配置<code>raw</code>表，要求不记录到连接跟踪表中。既然是为了提高性能，绕过连接跟踪表，很容易就想到是在数据包刚刚在系统中产生的时候就进行标记，根据上面的描述，数的在系统中产生有两个时机：刚进入网卡(PREROUTING)、刚由应用程序发出(OUTPUT)。看上图，raw表也仅存在于这两个链中。</p><p>在<code>PREROUTING</code>中，可以对数据包的五元组信息进行修改，以便调整数据包在后续的流向。所以在<code>PREROUTING</code>链中，有nat表。</p><p><code>FORWARD</code>链的作用，仅仅是将数据包从一个接口转发到另一个接口上，所以在这个链中，没有过多的复杂的操作。仅仅使用了<code>mangle</code>和<code>filter</code>表。</p><h1 id=应用场景>应用场景</h1><h2 id=snat>SNAT</h2><p><strong>SNAT</strong>即源地址转换，主要用于从局域网访问互联网时，将局域网IP地址转换为可以在互联网上使用的IP地址。根据原理，很容易确定是在将数据包发送到互联网上时进行转换，所以这个操作应该在<code>POSTROUTING</code>上操作。</p><h2 id=dnat>DNAT</h2><p><strong>DNAT</strong>即目的地址转换。在互联网上要访问内部的服务时，只能访问到网关上的端口，当数据一到达网关时，就需要修改目的地址，便于数据包的后续处理流程。根据原理，可以确定这个操作应该在<code>PREROUTING</code>链中进行。</p><h2 id=路由服务>路由服务</h2><p>在不需要NAT的情况下，由于只需要将数据从一个网络发送到另一个网络，两个网络通过同一台服务器的两个不同网卡进行连接，所以就需要根据路由规则，将数据从进入的网卡转发到另一个网卡发出。这个转发操作就是在<code>FORWARD</code>链。所以配置路由时，就一定要在<code>FORWARD</code>链的<code>filter</code>表中，允许数据包的转发。</p><p><strong>数据包的转发，需要在操作系统的内核中开启ipv4.ip_forward。</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sysctl -w net.ipv4.ip_forward<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> <span style=color:#75715e># 临时生效 </span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;net.ipv4.ip_forward=1&#34;</span> &gt;&gt; /etc/sysctl.conf <span style=color:#75715e># 永久生效</span>
</span></span></code></pre></div><p>可以说，<code>FORWARD</code> 链是构建 ​<strong>​Linux 网络防火墙​</strong>​ 和 ​<strong>​路由器功能​</strong>​ 的基石。</p><h2 id=安全控制>安全控制</h2><p>通过在链中对数据包进行<code>DROP</code>、<code>ACCEPT</code>、<code>REJECT</code>操作，可以设置白名单或黑名单的访问模式，从而拒绝未知的访问者对服务的访问。</p><p>在每个链上，可以设置一个默认规则，当没有匹配的详细规则时，则使用默认规则。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>iptables -P INPUT DROP
</span></span></code></pre></div><h1 id=iptables命令>iptables命令</h1><p>对<code>netfilter</code>的操作，就是将配置写入到各个链上相应的表中，主要是通过<code>iptables</code>来完成。</p><h2 id=查看>查看</h2><h3 id=查看全部配置>查看全部配置</h3><p>用于列出<code>netfilter</code>中的各种配置，通过命令<code>iptables --list</code>完成。通过<code>-n</code>参数可以以数字形式显示IP和端口。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>iptables --list -n
</span></span></code></pre></div><h3 id=查看指定链表配置>查看指定链表配置</h3><ul><li>-t 指定需要操作的表</li><li>-L 指定要操作的链</li></ul><p>可以通过指定<code>-t</code>和<code>-L</code>参数指定需要查看的表和链，链和表必须同时指定。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>iptables -L PREROUTING -t nat
</span></span></code></pre></div><h2 id=写入配置>写入配置</h2><p>对表的操作可以分为追加( A )、插入( I )、替换( R )、删除( D )，在写入时，也必须同时指定链和表。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>iptables -t nat -A POSTROUTING -o edge0 -j MASQUERADE
</span></span></code></pre></div><h2 id=清空规则>清空规则</h2><p>可以使用<code>-F</code>参数清空<code>netfilter</code>的所有规则，也强以清空指定链上的规则。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>iptables -F <span style=color:#75715e># 清空所有规则</span>
</span></span><span style=display:flex><span>iptables -F INPUT <span style=color:#75715e># 清空INPUT上的所有规则</span>
</span></span></code></pre></div><h2 id=其它操作>其它操作</h2><p><code>iptables</code>有很多操作参数，具体的使用可以通过<code>--help</code>来查看，也可以参考其它文章来了解。</p></div></div></main><footer><p>© Copyright 2025. All rights reserved.</p><p><a href=https://beian.miit.gov.cn/#/Integrated/index target=_blank>蜀ICP备2023031169号-1</a></p></footer></body></html>